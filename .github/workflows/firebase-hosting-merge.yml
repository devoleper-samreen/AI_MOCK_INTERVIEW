# # This file was auto-generated by the Firebase CLI
# # https://github.com/firebase/firebase-tools

# name: Deploy to Firebase Hosting on merge
# on:
#   push:
#     branches:
#       - main
# jobs:
#   build_and_deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - run: npm ci && npm run build
#       - uses: FirebaseExtended/action-hosting-deploy@v0
#         with:
#           repoToken: ${{ secrets.GITHUB_TOKEN }}
#           firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_AI_MOCK_INTERVIEW_DB3E3 }}
#           channelId: live
#           projectId: ai-mock-interview-db3e3

# Auto deploy to Firebase Hosting when code is pushed to main
name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Node.js (same version as local)
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Setup pnpm
      - uses: pnpm/action-setup@v2
        with:
          version: 8 # pnpm version used

      - name: Print github secrets
        run: |
          echo "FIREBASE API KEY ": ${{github.secrets.VITE_FIREBASE_API_KEY}}
          echo "GEMINI API KEY ": ${{github.secrets.VITE_GEMINI_API_KEY}}

      # Create .env.production instead of .env
      - name: Create .env.production
        run: |
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}" >> .env.production
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" >> .env.production
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" >> .env.production
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" >> .env.production
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" >> .env.production
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}" >> .env.production
          echo "VITE_GEMINI_API_KEY=${{ secrets.VITE_GEMINI_API_KEY }}" >> .env.production

      - name: Check env vars
        run: |
          echo "FIREBASE API KEY: $VITE_FIREBASE_API_KEY"
          echo "GEMINI API KEY: $VITE_GEMINI_API_KEY"

      # Install dependencies & build
      - run: pnpm install
      - run: pnpm run build -- --mode production

      # Deploy to Firebase
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_AI_MOCK_INTERVIEW_DB3E3 }}
          channelId: live
          projectId: ai-mock-interview-db3e3
